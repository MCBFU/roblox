local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local gui = Instance.new("ScreenGui")
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = player:WaitForChild("PlayerGui")

local label = Instance.new("TextLabel")
label.Size = UDim2.new(0, 200, 0, 80)
label.Position = UDim2.new(0.5, -100, 0.5, -40)
label.BackgroundTransparency = 1
label.Text = "   正在加载资源包中...\n请稍候"
label.Font = Enum.Font.GothamBold
label.TextSize = 36
label.TextColor3 = Color3.new(1, 1, 1)
label.TextStrokeColor3 = Color3.new(0, 0, 0)
label.TextStrokeTransparency = 0.5
label.Parent = gui

task.wait(3)
TweenService:Create(label, TweenInfo.new(0.5), {TextTransparency = 1, TextStrokeTransparency = 1}):Play()
task.wait(0.5)
gui:Destroy()


local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ContentProvider = game:GetService("ContentProvider")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- 水印UI 创建
local mcbGui = Instance.new("ScreenGui")
mcbGui.Name = "MCBWatermark"
mcbGui.ResetOnSpawn = false
mcbGui.IgnoreGuiInset = true
mcbGui.Parent = PlayerGui

local mcbMark = Instance.new("TextLabel")
mcbMark.Size = UDim2.new(0,60,0,20)
mcbMark.Position = UDim2.new(0.015,0,0.97,0)
mcbMark.AnchorPoint = Vector2.new(0,1)
mcbMark.BackgroundTransparency = 1
mcbMark.Text = "MCB材质GUI  BY  渔炒鱼"
mcbMark.Font = Enum.Font.GothamBold
mcbMark.TextSize = 10
mcbMark.TextTransparency = 0.7
mcbMark.TextColor3 = Color3.new(1,1,1)
mcbMark.TextStrokeTransparency = 0.9
mcbMark.TextStrokeColor3 = Color3.new(0,0.7,1)
mcbMark.ZIndex = 999
mcbMark.Parent = mcbGui
-- 水印呼吸动画
TweenService:Create(mcbMark,TweenInfo.new(6,Enum.EasingStyle.Sine,Enum.EasingDirection.InOut,-1),{TextTransparency=0.85,TextStrokeTransparency=0.95}):Play()

-- 加载界面 轻量初始化
local loadGui = Instance.new("ScreenGui")
loadGui.Name = "PremiumLoader"
loadGui.ResetOnSpawn = false
loadGui.IgnoreGuiInset = true
loadGui.Parent = PlayerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(1,0,1,0)
mainFrame.BackgroundTransparency = 1
mainFrame.Parent = loadGui

local loadImg = Instance.new("ImageLabel")
loadImg.Size = UDim2.new(1.1,0,1.1,0)
loadImg.Position = UDim2.new(-0.05,0,-0.05,0)
loadImg.BackgroundTransparency = 1
loadImg.Image = "rbxassetid://111333374680640"
loadImg.ScaleType = Enum.ScaleType.Crop
loadImg.ImageTransparency = 1
loadImg.Parent = mainFrame

local progressFrame = Instance.new("Frame")
progressFrame.Size = UDim2.new(0.12,0,0,4)
progressFrame.Position = UDim2.new(0.02,0,0.96,0)
progressFrame.BackgroundColor3 = Color3.new(0.08,0.08,0.08)
progressFrame.BackgroundTransparency = 1
progressFrame.AnchorPoint = Vector2.new(0,1)
progressFrame.Parent = mainFrame
Instance.new("UICorner",progressFrame).CornerRadius = UDim.new(1,0)

local progressBg = Instance.new("Frame")
progressBg.Size = UDim2.new(1,-2,1,-2)
progressBg.Position = UDim2.new(0,1,0,1)
progressBg.BackgroundColor3 = Color3.new(0.12,0.12,0.12)
progressBg.BackgroundTransparency = 0.7
progressBg.Parent = progressFrame
Instance.new("UICorner",progressBg).CornerRadius = UDim.new(1,0)

local progressBar = Instance.new("Frame")
progressBar.Size = UDim2.new(0,0,1,-2)
progressBar.Position = UDim2.new(0,1,0,1)
progressBar.BackgroundColor3 = Color3.new(0,0.78,1)
progressBar.BorderSizePixel = 0
progressBar.Parent = progressBg
Instance.new("UICorner",progressBar).CornerRadius = UDim.new(1,0)

local progressTxt = Instance.new("TextLabel")
progressTxt.Text = "0%"
progressTxt.Size = UDim2.new(0,40,0,240,0,20)
progressTxt.Position = UDim2.new(1,5,0,-8)
progressTxt.BackgroundTransparency = 1
progressTxt.TextColor3 = Color3.new(0,0.78,1)
progressTxt.Font = Enum.Font.GothamBold
progressTxt.TextSize = 14
progressTxt.TextTransparency = 1
progressTxt.Parent = progressFrame

-- 加载淡入动画 快速触发
TweenService:Create(loadImg,TweenInfo.new(0.3,Enum.EasingStyle.Quad),{ImageTransparency=0}):Play()
task.wait(0.1)
TweenService:Create(progressFrame,TweenInfo.new(0.2,Enum.EasingStyle.Quad),{BackgroundTransparency=0.8}):Play()
TweenService:Create(progressTxt,TweenInfo.new(0.2,Enum.EasingStyle.Quad),{TextTransparency=0}):Play()

-- 进度条快速推进 无冗余渲染
local progress = 0
repeat
    progress = math.min(progress + 5, 100)
    progressBar.Size = UDim2.new(progress/100,0,1,-2)
    progressTxt.Text = math.floor(progress).."%"
    task.wait(0.01)
until progress >= 100
progressTxt.Text = "100%"
task.wait(0.2)

-- 加载淡出动画 快速清理
TweenService:Create(progressFrame,TweenInfo.new(0.2,Enum.EasingStyle.Cubic),{BackgroundTransparency=1}):Play()
TweenService:Create(progressTxt,TweenInfo.new(0.2,Enum.EasingStyle.Cubic),{TextTransparency=1}):Play()
TweenService:Create(loadImg,TweenInfo.new(0.4,Enum.EasingStyle.Cubic),{ImageTransparency=1}):Play()
task.wait(0.5)
loadGui:Destroy()

-- 贴图替换表 [旧ID] = 新ID
local replaceImg = {
    ["9819025862"] = "5887957252",["18983980709"] = "1883128632",["733082708"] = "16876797391",["18143239786"] = "111333374680640",
    ["17873701775"] = "19005661344",["111766019087066"] = "19005661344",["84173824340486"] = "11419702905",["80280801657905"] = "12974453788",
    ["109696182350022"] = "12974362186",["11245756484"] = "11432834725",["3041611933"] = "10709790644",["18984010733"] = "11293978505",
    ["71894692127690"] = "98446998103932",["15459548442"] = "28872862",["18457697895"] = "1883128632",["17623366300"] = "15236655346",
    ["113441953421169"] = "98446998103932",["7792025253"] = "131794018998093",["18983984311"] = "12974446859",["18983985638"] = "15540208282",
    ["105124043854658"] = "11295273292",["16244554485"] = "77354540467357",["13518130183"] = "13910235294",["108218417623236"] = "123922080862042",
    ["18983982189"] = "18848424198",["18983983311"] = "7361324455",["18697280880"] = "11963356747",["117426859805043"] = "12967561554",
    ["112771731716467"] = "98446998103932",["9367208286"] = "11455761101",["11030033771"] = "11963356747",["16771569388"] = "76561912587311",
    ["16307805649"] = "10723433935",["16294678871"] = "11419666746",["128541005752913"] = "94698906864666",["71258592588220"] = "11814673280",
    ["483229625"] = "11419666746",["483231231"] = "11295275950",["8119252523"] = "14187749511",["96028253925505"] = "14188388240",
    ["18984040900"] = "11963364026",["5107199773"] = "100148515061030",["13050415802"] = "11245756484",["18318977415"] = "86119075739911",
    ["18318988523"] = "86119075739911",["125028983718775"] = "11295287158",["71943104392583"] = "11419666512",["5887957252"] = "11963364026",
    ["5945121255"] = "11963364026",["11901680822"] = "11963364026",["3124804643"] = "11963364026",["9525535512"] = "11245756484",
    ["112467754663467"] = "85052282749542",["74592393527729"] = "98540618745439",["114609020373684"] = "103943763384616",["123457018967026"] = "138603836848808",
    ["79899399105462"] = "83549476158609",["129283713909372"] = "16259096470",["18848139891"] = "12754479702",["18848327399"] = "12817454402",
    ["18861353517"] = "11963365322",["101804118103190"] = "4625478089",["93426961710317"] = "4625478089",["104232165431178"] = "4625478089",
    ["120452710152785"] = "4625478089",["95825012919180"] = "4625478089",["77823426566285"] = "4625478089",["18395608861"] = "76561912587311",
    ["7539983773"] = "11432855214"
}

-- 音效替换表 [旧ID] = 新ID（空值则静音）
local replaceSnd = {
    ["85947068032779"] = "11963364026",["17754462333"] = "",["127588576195602"] = "16190782181",["7048844460"] = "11963364026",
    ["6027236630"] = "121714577724271",["77641329246584"] = "121714577724271",["134749582867639"] = "121714577724271",["131298589984160"] = "121714577724271",
    ["118826043355401"] = "121714577724271",["102502859803169"] = "9126102254",["90782284167817"] = "111358125948665",["8509804480"] = "8509804480",
    ["6461775588"] = "8509804480",["6027236630"] = "119031191462818",["119547018329590"] = "15689445424",["9042971851"] = "133701137571082",
    ["6794886454"] = "94624102598882",["268933841"] = "8400918001",["1014740409"] = "94624102598882",["6052548458"] = "7390036132",
    ["81953263341178"] = "94624102598882",["4697381311"] = "94624102598882",["17779172376"] = "78979695510585",["105708271085646"] = "9040093731",
    ["15161202088"] = "9040093731",["70802680979187"] = "9040093731",["18580125132"] = "9040093731",["93555365323626"] = "6592039185",
    ["9047227058"] = "6698737249",["17754461645"] = "102635449518574",["102227464743820"] = "1838285490",["18108930258"] = "86764987673138",
    ["4458750140"] = "79486256972927",["18108929583"] = "88694618694614773673",["136847579"] = "4685847723",["17830578431"] = "9113988327",
    ["100117953439271"] = "1014740409",["17830572203"] = "17830572203",["9125467397"] = "15746991650",["131136929849120"] = "166047422",
    ["18783467913"] = "106235104957151",["18108929972"] = "17754461645",["103208711906653"] = "15183765436",["125643578367125"] = "8400918001",
    ["130307677976118"] = "166047422",["139792801528961"] = "90645451074699",["89226672351498"] = "93411834929338",["81665056647548"] = "93411834929338",
    ["5312518467"] = "70406650561771",["120625154390198"] = "9120059083",["9116385079"] = "166047422",["115504092505776"] = "6592039185",
    ["9125844189"] = "79130056188513",["9113678359"] = "79130056188513",["9118398526"] = "79130056188513",["1837829154"] = "79486256972927",
    ["1837829473"] = "79486256972927",["9116698830"] = "79486256972927",["9116684733"] = "79130056188513",["3521543186"] = "79130056188513",
    ["147722227"] = "79130056188513",["125677551407985"] = "4685847723",["4681189157"] = "5694665239",["4678745096"] = "5694665239",
    ["4681189562"] = "5694665239",["112282490730834"] = "",["116093533132760"] = "",["116423712355422"] = "",
    ["115504092505776"] = "",["106779899806168"] = "",["112771731716467"] = "79130056188513",["17856099558"] = "",
    ["119794608146606"] = "1840172845",["907514098"] = "6698737249",["9119701012"] = "79130056188513"
}

-- 预加载优化：异步预加载 不阻塞主线程
task.spawn(function()
    local preloadList = {}
    for _,newId in pairs(replaceImg) do table.insert(preloadList, "rbxassetid://"..newId) end
    for _,newId in pairs(replaceSnd) do if newId ~= "" then table.insert(preloadList, "rbxassetid://"..newId) end end
    pcall(function() ContentProvider:PreloadAsync(preloadList) end)
end)

-- 核心替换函数：精准匹配+单次遍历 无冗余
local function doReplace(obj)
    local target = obj and {obj} or game:GetDescendants()
    -- 贴图替换
    for oldId,newId in pairs(replaceImg) do
        local oldAsset = "rbxassetid://"..oldId
        local newAsset = "rbxassetid://"..newId
        for _,v in pairs(target) do
            pcall(function()
                if v:IsA("ImageLabel") or v:IsA("ImageButton") then v.Image = v.Image == oldAsset and newAsset or v.Image end
                if v:IsA("Decal") or v:IsA("Texture") then v.Texture = v.Texture == oldAsset and newAsset or v.Texture end
            end)
        end
    end
    -- 音效替换
    for oldId,newId in pairs(replaceSnd) do
        local oldAsset = "rbxassetid://"..oldId
        local newAsset = newId == "" and "" or "rbxassetid://"..newId
        for _,v in pairs(target) do
            pcall(function() if v:IsA("Sound") then v.SoundId = v.SoundId == oldAsset and newAsset or v.SoundId end end)
        end
    end
end

-- 替换逻辑极致优化：1次全量替换 + 精准监听新增 无循环兜底
doReplace()
-- 新增对象仅替换当前对象 不全局遍历 大幅降负载
game.DescendantAdded:Connect(function(obj)
    task.spawn(doReplace, obj)
end)